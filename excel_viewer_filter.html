<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Dati - Visualizzatore Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .filters {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
            font-size: 0.9em;
        }
        
        .filter-group input, .filter-group select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 150px;
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tbody tr {
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.2em;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 1.1em;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.2em;
        }
        
        .btn-reset {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .btn-reset:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Gestione Dati</h1>
            <p>Visualizzazione e filtro dati</p>
        </div>
        
        <div class="filters" id="filterSection" style="display: none;">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>üîç Cerca per nome/cognome</label>
                    <input type="text" id="searchName" placeholder="Digita nome o cognome...">
                </div>
                
                <div class="filter-group">
                    <label>üéÇ Et√† minima</label>
                    <input type="number" id="minAge" placeholder="Es: 18" min="0">
                </div>
                
                <div class="filter-group">
                    <label>üéÇ Et√† massima</label>
                    <input type="number" id="maxAge" placeholder="Es: 65" min="0">
                </div>
                
                <div class="filter-group">
                    <label>üè´ Classe</label>
                    <select id="filterClass">
                        <option value="">Tutte le classi</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>üìç Comune</label>
                    <input type="text" id="searchComune" placeholder="Cerca comune...">
                </div>
                
                <div class="filter-group">
                    <label>üè† Indirizzo</label>
                    <input type="text" id="searchIndirizzo" placeholder="Cerca indirizzo...">
                </div>
            </div>
            
            <button class="btn-reset" onclick="resetFilters()">üîÑ Resetta Filtri</button>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="totalRecords">0</div>
                    <div class="label">Totale record</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="visibleRecords">0</div>
                    <div class="label">Record visualizzati</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="avgAge">-</div>
                    <div class="label">Et√† media</div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <div id="tableContent" class="loading">
                Caricamento dati in corso
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        
        // CONFIGURA QUI IL PERCORSO DEL TUO FILE EXCEL
        const EXCEL_FILE_PATH = 'dati.xlsx'; // Cambia con il nome del tuo file
        
        // Carica automaticamente il file all'avvio
        window.addEventListener('load', function() {
            loadExcelFromRepo();
        });
        
        async function loadExcelFromRepo() {
            try {
                const response = await fetch(EXCEL_FILE_PATH);
                
                if (!response.ok) {
                    throw new Error(`File non trovato: ${EXCEL_FILE_PATH}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                allData = jsonData.map(row => ({
                    cognome: row['COGNOME'] || '',
                    nome: row['NOME'] || '',
                    comune: row['COMUNE DI NASCITA'] || '',
                    dataNascita: row['DATA DI NASCITA'] || '',
                    anni: row['ANNI'] || calculateAge(row['DATA DI NASCITA']),
                    classe: row['CLASSE'] || '',
                    indirizzo: row['INDIRIZZO'] || '',
                    email: row['EMAIL'] || '',
                    tel: row['TEL'] || '',
                    altroTel: row['altro tel.'] || row['altro tel'] || ''
                }));
                
                populateClassFilter();
                document.getElementById('filterSection').style.display = 'block';
                renderTable(allData);
                updateStats(allData);
                attachFilterListeners();
                
            } catch (error) {
                console.error('Errore nel caricamento:', error);
                document.getElementById('tableContent').innerHTML = `
                    <div class="error">
                        ‚ùå Errore nel caricamento del file<br>
                        <small>Verifica che il file "${EXCEL_FILE_PATH}" esista nella repository</small><br>
                        <small style="color: #6c757d;">${error.message}</small>
                    </div>
                `;
            }
        }
        
        function calculateAge(dateString) {
            if (!dateString) return '';
            const birthDate = new Date(dateString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }
        
        function populateClassFilter() {
            const classes = [...new Set(allData.map(d => d.classe).filter(c => c))].sort();
            const select = document.getElementById('filterClass');
            select.innerHTML = '<option value="">Tutte le classi</option>';
            classes.forEach(c => {
                select.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }
        
        function renderTable(data) {
            const container = document.getElementById('tableContent');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="no-data">Nessun dato da visualizzare</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Cognome</th>
                            <th>Nome</th>
                            <th>Comune</th>
                            <th>Data Nascita</th>
                            <th>Et√†</th>
                            <th>Classe</th>
                            <th>Indirizzo</th>
                            <th>Email</th>
                            <th>Tel</th>
                            <th>Altro Tel</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(row => {
                html += `
                    <tr>
                        <td>${row.cognome}</td>
                        <td>${row.nome}</td>
                        <td>${row.comune}</td>
                        <td>${row.dataNascita}</td>
                        <td><strong>${row.anni}</strong></td>
                        <td>${row.classe}</td>
                        <td>${row.indirizzo}</td>
                        <td>${row.email}</td>
                        <td>${row.tel}</td>
                        <td>${row.altroTel}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function filterData() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const minAge = parseInt(document.getElementById('minAge').value) || 0;
            const maxAge = parseInt(document.getElementById('maxAge').value) || 999;
            const filterClass = document.getElementById('filterClass').value;
            const searchComune = document.getElementById('searchComune').value.toLowerCase();
            const searchIndirizzo = document.getElementById('searchIndirizzo').value.toLowerCase();
            
            const filtered = allData.filter(row => {
                const fullName = (row.cognome + ' ' + row.nome).toLowerCase();
                const age = parseInt(row.anni) || 0;
                
                return (
                    fullName.includes(searchName) &&
                    age >= minAge &&
                    age <= maxAge &&
                    (filterClass === '' || row.classe === filterClass) &&
                    row.comune.toLowerCase().includes(searchComune) &&
                    row.indirizzo.toLowerCase().includes(searchIndirizzo)
                );
            });
            
            renderTable(filtered);
            updateStats(filtered);
        }
        
        function updateStats(data) {
            document.getElementById('totalRecords').textContent = allData.length;
            document.getElementById('visibleRecords').textContent = data.length;
            
            const ages = data.map(d => parseInt(d.anni)).filter(a => !isNaN(a));
            if (ages.length > 0) {
                const avgAge = (ages.reduce((a, b) => a + b, 0) / ages.length).toFixed(1);
                document.getElementById('avgAge').textContent = avgAge;
            } else {
                document.getElementById('avgAge').textContent = '-';
            }
        }
        
        function resetFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('minAge').value = '';
            document.getElementById('maxAge').value = '';
            document.getElementById('filterClass').value = '';
            document.getElementById('searchComune').value = '';
            document.getElementById('searchIndirizzo').value = '';
            filterData();
        }
        
        function attachFilterListeners() {
            document.getElementById('searchName').addEventListener('input', filterData);
            document.getElementById('minAge').addEventListener('input', filterData);
            document.getElementById('maxAge').addEventListener('input', filterData);
            document.getElementById('filterClass').addEventListener('change', filterData);
            document.getElementById('searchComune').addEventListener('input', filterData);
            document.getElementById('searchIndirizzo').addEventListener('input', filterData);
        }
    </script>
</body>
</html>